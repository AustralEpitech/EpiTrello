{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
     <meta charset="UTF-8">
     <title>{{ board.title }} - EpiTrello</title>
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <script src="https://cdn.tailwindcss.com"></script>
     <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js" defer></script>
    <link rel="stylesheet" href="{% static 'boards/theme.css' %}">
    <script src="{% static 'boards/app.js' %}" defer></script>
 </head>
<body class="min-h-screen bg-slate-950 text-white">
    <div id="toast-stack" class="fixed inset-x-0 top-6 z-50 mx-auto flex max-w-md flex-col gap-3 px-4"></div>
    
    <div id="global-loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/20 backdrop-blur-[1px] opacity-0 invisible">
        <div class="flex flex-col items-center gap-3">
            <div class="spinner"></div>
            <p class="text-xs font-bold uppercase tracking-[0.2em] text-emerald-400">Synchronisation...</p>
        </div>
    </div>
    <div class="flex min-h-screen flex-col">
        <header class="sticky top-0 z-30 border-b border-white/10 bg-slate-950/80 backdrop-blur">
            <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-4 px-4 py-4">
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='{% url 'boards:board_list' %}'" class="tooltip rounded-full border border-white/10 px-3 py-1 text-xs text-white hover:bg-white/10 btn-focus-visible" data-tooltip="Retour aux tableaux">‚Üê</button>
                    <div>
                        <p class="text-xs uppercase tracking-[0.4em] text-slate-400">EpiTrello</p>
                        <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                            {{ board.title }}
                            <span class="rounded-full border border-white/10 px-2 py-0.5 text-[10px] uppercase tracking-wide text-slate-300">{{ board.lists.count }} listes</span>
                        </h1>
                        <p class="text-sm text-slate-400">Propri√©taire : {{ board.owner }}</p>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 text-sm">
                    <a href="{% url 'boards:global_search' %}" class="rounded-full bg-white/10 p-2 text-white hover:bg-white/20 btn-focus-visible" data-tooltip="Recherche globale">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </a>
                    <form method="get" action="" class="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-white">
                        <svg class="h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" name="q" placeholder="Rechercher" class="bg-transparent text-sm text-white placeholder-slate-500 focus:outline-none" value="{{ request.GET.q }}">
                    </form>
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="card-sort" class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-semibold text-white focus:border-emerald-400 focus:outline-none" onchange="applySort(this.value)">
                            <option value="position" class="text-slate-900" {% if current_sort == 'position' %}selected{% endif %}>Tri manuel</option>
                            <option value="title" class="text-slate-900" {% if current_sort == 'title' %}selected{% endif %}>Titre (A-Z)</option>
                            <option value="due_date" class="text-slate-900" {% if current_sort == 'due_date' %}selected{% endif %}>Date d'√©ch√©ance</option>
                            <option value="created_at" class="text-slate-900" {% if current_sort == 'created_at' %}selected{% endif %}>Plus r√©centes</option>
                            <option value="label" class="text-slate-900" {% if current_sort == 'label' %}selected{% endif %}>Label (A-Z)</option>
                        </select>
                        <div class="flex gap-2">
                            <div class="relative">
                                <button id="filter-btn" class="tooltip rounded-full border border-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/10 btn-focus-visible" data-tooltip="Filtrer les cartes">Filtrer</button>
                                <div id="filter-dropdown" class="absolute right-0 mt-2 w-64 rounded-2xl bg-white p-4 shadow-2xl ring-1 ring-black/5 hidden z-50 text-slate-900">
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Labels</p>
                                            <div id="filter-labels-container" class="mt-2 flex flex-wrap gap-1">
                                                {% for label in board_labels %}
                                                    <button type="button" class="rounded-full px-2 py-1 text-[10px] font-semibold text-white filter-label-btn border-2 border-transparent transition" 
                                                            style="background-color: {{ label.color }}" 
                                                            data-filter-label="{{ label.id }}">
                                                        {{ label.name }}
                                                    </button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400">√âch√©ance</p>
                                            <div class="mt-2 space-y-1">
                                                <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-emerald-600">
                                                    <input type="checkbox" name="filter-date" value="overdue" class="rounded border-slate-300"> En retard
                                                </label>
                                                <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-emerald-600">
                                                    <input type="checkbox" name="filter-date" value="today" class="rounded border-slate-300"> Aujourd'hui
                                                </label>
                                                <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-emerald-600">
                                                    <input type="checkbox" name="filter-date" value="nodate" class="rounded border-slate-300"> Sans date
                                                </label>
                                            </div>
                                        </div>
                                        <button id="clear-filters" class="w-full rounded-lg bg-slate-100 py-2 text-[10px] font-bold uppercase text-slate-500 hover:bg-slate-200 hover:text-slate-700">Effacer les filtres</button>
                                    </div>
                                </div>
                            </div>
                            {% if board.owner == user %}
                            <a href="{% url 'boards:manage_members' board.id %}" class="tooltip rounded-full border border-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/10 btn-focus-visible" data-tooltip="G√©rer les membres">Membres</a>
                            <div class="relative" id="export-menu">
                                <button id="export-btn" class="tooltip rounded-full border border-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/10 btn-focus-visible" data-tooltip="Exporter le tableau">Exporter</button>
                                <div id="export-dropdown" class="absolute right-0 mt-2 w-48 rounded-2xl bg-white p-2 shadow-2xl ring-1 ring-black/5 hidden z-50 text-slate-900">
                                    <a href="{% url 'boards:export_board' board.id 'json' %}" class="block w-full text-left rounded-lg px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-100">Exporter en JSON</a>
                                    <a href="{% url 'boards:export_board' board.id 'csv' %}" class="block w-full text-left rounded-lg px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-100">Exporter en CSV</a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if board.owner == user %}
                    <form method="post" action="{% url 'boards:invite_member' board.id %}" class="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2">
                        {% csrf_token %}
                        <input type="text" name="username" placeholder="Inviter (pseudo)" class="bg-transparent text-xs text-white placeholder-slate-500 focus:outline-none">
                        <button type="submit" class="rounded-full bg-emerald-400 px-3 py-1 text-xs font-semibold text-slate-900 hover:bg-emerald-300" data-tooltip="Inviter un membre">Inviter</button>
                    </form>
                    {% endif %}
                    {% if user.is_authenticated %}
                    <a href="{% url 'boards:notifications_list' %}" class="relative rounded-full bg-white/10 p-2 text-white hover:bg-white/20 btn-focus-visible" data-tooltip="Mes notifications">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        {% if unread_notifications_count > 0 %}
                            <span class="absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-emerald-500 text-[10px] font-bold text-slate-900">{{ unread_notifications_count }}</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'boards:profile' %}" class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-400 font-bold text-slate-900 hover:bg-emerald-300 btn-focus-visible shadow-lg" data-tooltip="Mon Profil">
                        {{ user.username|slice:":1"|upper }}
                    </a>
                    {% endif %}
                </div>
            </div>
         </header>

         <main class="flex-1 overflow-x-auto bg-gradient-to-b from-slate-950 via-slate-930 to-slate-900">
             <div class="mx-auto flex min-h-[calc(100vh-220px)] max-w-7xl gap-4 px-4 py-6" id="board-canvas">
                 {% for list in board.lists.all %}
                    <div class="w-80 flex-shrink-0 rounded-3xl border border-white/10 bg-white/5 p-4 shadow-xl transition" data-list-id="{{ list.id }}">
                        <div class="flex items-center justify-between text-white">
                            <div class="flex items-center gap-2">
                                <button type="button" class="tooltip rounded-full border border-white/10 px-2 py-1 text-xs text-white hover:bg-white/10 btn-focus-visible" data-tooltip="R√©duire" data-collapse-toggle>
                                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                </button>
                                <h2 class="text-base font-semibold">{{ list.title }}</h2>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="tooltip rounded-full border border-white/10 px-3 py-1 text-xs text-white hover:bg-white/10 btn-focus-visible" data-tooltip="Ajouter une carte" onclick="toggleCardForm('{{ list.id }}')">+</button>
                                <form method="post" action="{% url 'boards:delete_list' board.id list.id %}" onsubmit="return window.handleConfirmSubmit(event, 'Supprimer cette liste ?', this);">
                                    {% csrf_token %}
                                    <button type="submit" class="tooltip rounded-full border border-red-300/40 px-2 py-1 text-[10px] font-semibold text-red-200 hover:bg-red-500/10 btn-focus-visible" data-tooltip="Supprimer la liste">‚úï</button>
                                </form>
                            </div>
                        </div>
                        <div class="card-container mt-4 flex flex-col gap-3" data-list-id="{{ list.id }}">
                            {% for card in list.cached_cards %}
                                <article class="group rounded-2xl border border-white/10 bg-slate-950/60 p-4 text-white shadow transition hover:-translate-y-1" 
                                         data-card-id="{{ card.id }}"
                                         data-card-labels="{% for l in card.labels.all %}{{ l.id }},{% endfor %}"
                                         data-card-due="{{ card.due_date|date:'Y-m-d' }}"
                                         data-card-overdue="{% if card.due_date and card.due_date < now %}1{% else %}0{% endif %}"
                                >
                                     <div class="flex items-start justify-between">
                                         <h3 class="text-sm font-semibold leading-tight">{{ card.title }}</h3>
                                         <div class="flex items-center gap-2">
                                             <div class="flex -space-x-1.5 overflow-hidden" data-card-assignees="{{ card.id }}">
                                                 {% for u in card.assigned_to.all %}
                                                     <div class="inline-block h-5 w-5 rounded-full border border-slate-900 bg-emerald-400 text-[9px] font-bold text-slate-900 flex items-center justify-center" title="{{ u.username }}">
                                                         {{ u.username|slice:":1"|upper }}
                                                     </div>
                                                 {% endfor %}
                                             </div>
                                             <span data-card-due-display="" class="text-xs font-semibold {% if card.due_date and card.due_date < now %}text-red-400{% else %}text-emerald-300{% endif %} {% if not card.due_date %}hidden{% endif %}">
                                                 {% if card.due_date %}üìÖ {{ card.due_date|date:"d/m" }}{% endif %}
                                             </span>
                                             <button type="button" class="tooltip rounded-full p-1 text-slate-500 hover:bg-white/10 hover:text-red-400 transition opacity-0 group-hover:opacity-100 focus:opacity-100" data-tooltip="Archiver" onclick="event.stopPropagation(); window.quickDeleteCard('{{ card.id }}')">
                                                 <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                             </button>
                                         </div>
                                     </div>
                                     {% if card.labels.all %}
                                         <div data-card-labels="" class="mt-3 flex flex-wrap gap-2">
                                             {% for label in card.labels.all %}
                                                 <span class="inline-flex items-center rounded-full px-2 py-1 text-[10px] font-semibold text-white" style="background-color: {{ label.color }}">
                                                     {{ label.name }}
                                                 </span>
                                             {% endfor %}
                                         </div>
                                     {% else %}
                                         <div data-card-labels="" class="mt-3 flex flex-wrap gap-2 hidden"></div>
                                     {% endif %}
                                     <p data-card-description="" class="mt-2 text-sm text-slate-300 line-clamp-3 {% if not card.description %}hidden{% endif %}">{{ card.description }}</p>
                                     <div class="mt-4 flex items-center justify-between text-xs text-slate-400">
                                         <span data-card-stats-subtasks="">‚úÖ {{ card.completed_subtasks }}/{{ card.total_subtasks }}</span>
                                         <span data-card-stats-comments="">üí¨ {{ card.comment_count }}</span>
                                      </div>
                                  </article>
                             {% endfor %}
                            <div class="empty-state text-xs text-slate-300 {% if list.cached_cards %}hidden{% endif %}" data-empty-state="{{ list.id }}">
                                <p class="empty-state-icon text-lg">üì≠</p>
                                <p>Pas encore de carte.</p>
                                <p class="text-[11px] text-slate-500">Ajoute ta premi√®re t√¢che pour d√©marrer.</p>
                            </div>
                         </div>
                         <div class="mt-4">
                             <form method="post" action="{% url 'boards:create_card' board.id %}" class="space-y-2 hidden" data-card-form="{{ list.id }}">
                                 {% csrf_token %}
                                 <input type="hidden" name="list_id" value="{{ list.id }}">
                                 <input type="text" name="title" placeholder="Titre" class="w-full rounded-xl border border-white/10 bg-slate-900/30 px-3 py-2 text-sm text-white focus:border-emerald-400 focus:outline-none" required>
                                 <textarea name="description" rows="2" placeholder="Description" class="no-resize w-full rounded-xl border border-white/10 bg-slate-900/30 px-3 py-2 text-sm text-white focus:border-emerald-400 focus:outline-none"></textarea>
                                 <button type="submit" class="c-button w-full rounded-xl bg-emerald-400 px-3 py-2 text-sm font-semibold text-slate-900">Ajouter</button>
                             </form>
                             <button type="button" class="mt-2 w-full rounded-xl border border-dashed border-white/20 px-3 py-2 text-sm text-white hover:bg-white/5" onclick="toggleCardForm('{{ list.id }}')">+ Nouvelle carte</button>
                         </div>
                    </div>
                {% endfor %}
                <div class="flex w-64 flex-shrink-0 flex-col gap-2 rounded-3xl border border-dashed border-white/20 bg-white/5 p-4 text-sm text-white ignore-drag">
                    <p class="font-semibold">Ajouter une liste</p>
                    <form method="post" action="{% url 'boards:create_list' board.id %}" class="space-y-2" data-card-form="global">
                        {% csrf_token %}
                        <input type="text" name="title" placeholder="Titre" class="w-full rounded-xl border border-white/20 bg-slate-900/40 px-3 py-2 text-sm text-white focus:border-emerald-400 focus:outline-none" required>
                        <button class="w-full rounded-xl bg-emerald-400 px-3 py-2 text-sm font-semibold text-slate-900">Cr√©er</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="card-modal" class="fixed inset-0 z-40 hidden overflow-y-auto bg-slate-900/60 px-4 py-6 text-slate-900 sm:py-10">
        <div class="mx-auto w-full max-w-4xl rounded-2xl bg-white shadow-2xl">
            <div class="flex items-center justify-between border-b border-slate-100 px-6 py-4">
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-400">Carte</p>
                    <h2 id="modal-card-title" class="text-2xl font-semibold"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="card-delete-mobile" class="lg:hidden rounded-full p-2 text-red-500 hover:bg-red-50" data-tooltip="Archiver la carte">
                        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                    </button>
                    <button id="modal-close" class="rounded-full border border-slate-200 px-3 py-1 text-sm font-semibold text-slate-500 hover:bg-slate-50" data-tooltip="Fermer la vue">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="grid gap-6 px-6 py-6 lg:grid-cols-[2fr,1fr]">
                <div class="space-y-6">
                    <form id="card-main-form" class="space-y-3">
                        <input type="hidden" name="card-id">
                        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Titre</label>
                        <input name="title" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none" required>
                        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Date limite</label>
                        <input type="datetime-local" name="due_date" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none">
                        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Description</label>
                        <textarea name="description" rows="4" class="no-resize no-focus-outline w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-emerald-400 focus:ring-0 focus:outline-none" placeholder="Ajoute des d√©tails" style="resize:none;overflow:auto;"></textarea>
                        <button class="c-button rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white" data-tooltip="Enregistrer les modifications">Sauvegarder</button>
                    </form>

                    <div id="checklists-container" class="space-y-6"></div>

                    <section>
                        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Membres assign√©s</h3>
                        <div id="modal-assigned-members" class="mt-3 flex flex-wrap gap-2"></div>
                        <div class="mt-4 space-y-2">
                             <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Assigner un membre</p>
                             <div id="members-list-toggle" class="flex flex-wrap gap-2"></div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Commentaires</h3>
                        <form id="comment-create" class="mt-3 flex gap-2 text-sm">
                            <textarea name="content" rows="2" class="no-resize flex-1 rounded-md border border-slate-200 px-3 py-2" placeholder="√âcrire un commentaire..."></textarea>
                            <button class="c-button rounded-md bg-slate-900 px-3 py-2 text-sm font-semibold text-white" data-tooltip="Publier le commentaire">Envoyer</button>
                        </form>
                        <ul id="comments-list" class="mt-4 space-y-3 text-sm"></ul>
                    </section>
                </div>

                <aside class="order-first space-y-6 lg:order-last">
                    <section>
                        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Labels</h3>
                        <div id="labels-pills" class="mt-3 flex flex-wrap gap-2"></div>
                        <form id="label-create" class="mt-4 space-y-2 text-sm">
                            <input type="text" name="name" placeholder="Nom du label" class="w-full rounded-md border border-slate-200 px-3 py-2 focus:border-blue-500 focus:outline-none">
                            <input type="color" name="color" value="#3b82f6" class="h-10 w-full rounded-md border border-slate-200">
                            <button class="c-button w-full rounded-md bg-slate-900 px-3 py-2 text-sm font-semibold text-white" data-tooltip="Cr√©er une nouvelle √©tiquette">Cr√©er un label</button>
                        </form>
                    </section>
                    <section class="space-y-3">
                        <button id="btn-add-checklist" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">‚òë Checklist</button>
                        <div id="checklist-form" class="hidden space-y-2 rounded-lg border border-slate-100 bg-slate-50 p-3">
                            <input type="text" id="checklist-title-input" placeholder="Titre de la checklist" class="w-full rounded-md border border-slate-200 px-2 py-1 text-sm focus:border-emerald-400 focus:outline-none">
                            <div class="flex gap-2">
                                <button id="checklist-create-confirm" class="rounded-md bg-emerald-600 px-3 py-1 text-xs font-semibold text-white">Ajouter</button>
                                <button id="checklist-create-cancel" class="text-xs text-slate-500">Annuler</button>
                            </div>
                        </div>
                    </section>
                    <section class="rounded-lg border border-slate-100 bg-slate-50 p-4 text-sm text-slate-600">
                        <button id="card-delete" class="w-full rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm font-semibold text-red-600 hover:bg-red-100" data-tooltip="Archiver cette carte">Archiver la carte</button>
                    </section>
                </aside>
            </div>
        </div>
    </div>

    <script>
        const toastStack = document.getElementById('toast-stack')

        function pushToast(message, variant = 'success') {
             const tone = variant.includes('error') ? 'red' : 'emerald'
             const toast = document.createElement('div')
             toast.className = `rounded-2xl border border-${tone}-300/40 bg-white/90 px-4 py-2 text-sm font-medium text-slate-900 shadow-lg backdrop-blur transition`
             toast.textContent = message
             toastStack.appendChild(toast)
             setTimeout(() => {
                 toast.classList.add('translate-y-1', 'opacity-0')
                 toast.addEventListener('transitionend', () => toast.remove())
             }, 2600)
         }
        window.pushToast = pushToast

        window.confirmAction = async (message) => {
            return new Promise((resolve) => {
                const confirmed = window.confirm(message)
                resolve(confirmed)
            })
        }

        let activeFilter = null

        {% if messages %}
            {% for message in messages %}
                window.pushToast("{{ message|escapejs }}", "{{ message.tags }}")
            {% endfor %}
        {% endif %}
        function applySort(value) {
            const url = new URL(window.location.href)
            url.searchParams.set('sort', value)
            window.location.href = url.toString()
        }
        function setFilter(type) {
            activeFilter = type
            pushToast(`Le filtre '${type}' a √©t√© activ√©.`, 'info')
        }
        function toggleListForm(id) {
            const form = document.querySelector(`[data-card-form="${id}"]`)
            if (form) form.classList.toggle('hidden')
        }
        function openQuickCard() {}
        const highlightResults = (needle) => {
             const query = (needle || '').trim().toLowerCase()
             applyFilters()
         }

        const refreshEmptyState = (target) => {
            const container = target?.closest ? target.closest('.card-container') : target
            if (!container) return
            const placeholder = container.querySelector('[data-empty-state]')
            if (!placeholder) return
            const hasCards = container.querySelectorAll('[data-card-id]').length > 0
            placeholder.classList.toggle('hidden', hasCards)
        }

        const filterBtn = document.getElementById('filter-btn')
        const filterDropdown = document.getElementById('filter-dropdown')
        const filterLabels = document.querySelectorAll('[data-filter-label]')
        const filterDates = document.querySelectorAll('input[name="filter-date"]')
        const clearFiltersBtn = document.getElementById('clear-filters')

        let activeFilters = {
            labels: new Set(),
            dates: new Set()
        }

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            filterDropdown.classList.toggle('hidden')
        })

        document.addEventListener('click', (e) => {
            if (!filterDropdown.contains(e.target) && e.target !== filterBtn) {
                filterDropdown.classList.add('hidden')
            }
        })

        filterLabels.forEach(btn => {
            btn.addEventListener('click', () => {
                const labelId = btn.dataset.filterLabel
                if (activeFilters.labels.has(labelId)) {
                    activeFilters.labels.delete(labelId)
                    btn.classList.remove('border-emerald-400', 'ring-2', 'ring-emerald-400')
                    btn.classList.add('border-transparent')
                } else {
                    activeFilters.labels.add(labelId)
                    btn.classList.remove('border-transparent')
                    btn.classList.add('border-emerald-400', 'ring-2', 'ring-emerald-400')
                }
                applyFilters()
            })
        })

        filterDates.forEach(input => {
            input.addEventListener('change', () => {
                const dateVal = input.value
                if (input.checked) activeFilters.dates.add(dateVal)
                else activeFilters.dates.delete(dateVal)
                applyFilters()
            })
        })

        clearFiltersBtn.addEventListener('click', () => {
            activeFilters.labels.clear()
            activeFilters.dates.clear()
            filterLabels.forEach(btn => {
                btn.classList.remove('border-emerald-400', 'ring-2', 'ring-emerald-400')
                btn.classList.add('border-transparent')
            })
            filterDates.forEach(input => input.checked = false)
            if (searchInput) searchInput.value = ''
            applyFilters()
        })

        function applyFilters() {
            const query = (searchInput?.value || '').trim().toLowerCase()
            const today = new Date().toISOString().split('T')[0]

            document.querySelectorAll('article[data-card-id]').forEach(card => {
                const cardLabels = card.dataset.cardLabels.split(',').filter(Boolean)
                const cardDue = card.dataset.cardDue
                const isOverdue = card.dataset.cardOverdue === '1'
                const title = card.querySelector('h3')?.textContent.toLowerCase() || ''

                let visible = true

                // Filter by search query
                if (query && !title.includes(query)) visible = false

                // Filter by labels (must have ALL selected labels? Or ANY?)
                // Trello filter by ANY selected label usually.
                if (activeFilters.labels.size > 0) {
                    const hasLabel = [...activeFilters.labels].some(l => cardLabels.includes(l))
                    if (!hasLabel) visible = false
                }

                // Filter by dates
                if (activeFilters.dates.size > 0) {
                    let dateMatch = false
                    if (activeFilters.dates.has('overdue') && isOverdue) dateMatch = true
                    if (activeFilters.dates.has('today') && cardDue === today) dateMatch = true
                    if (activeFilters.dates.has('nodate') && !cardDue) dateMatch = true
                    if (!dateMatch) visible = false
                }

                card.classList.toggle('hidden', !visible)
                
                // Si on utilise la recherche, on garde l'effet de highlight s'il est visible
                if (query && visible) {
                    card.classList.add('ring-2', 'ring-emerald-400')
                } else {
                    card.classList.remove('ring-2', 'ring-emerald-400')
                }
            })
            
            document.querySelectorAll('.card-container').forEach(refreshEmptyState)
        }

        const loader = document.getElementById('global-loader')
        const showLoader = () => { loader.classList.remove('opacity-0', 'invisible'); loader.classList.add('opacity-100', 'visible') }
        const hideLoader = () => { loader.classList.add('opacity-0', 'invisible'); loader.classList.remove('opacity-100', 'visible') }

         function toggleCardForm(listId) {
              const form = document.querySelector(`[data-card-form="${listId}"]`);
              if (!form) return;
              form.classList.toggle("hidden");
         }

        const searchInput = document.querySelector('input[name="q"]')
        if (searchInput) {
            searchInput.addEventListener('input', (event) => {
                highlightResults(event.target.value)
            })
            highlightResults(searchInput.value)
        }

        const modal = document.getElementById('card-modal')
        const closeModal = () => modal.classList.add('hidden')
        document.getElementById('modal-close').addEventListener('click', closeModal)
        modal.addEventListener('click', (event) => {
            if (event.target === modal) closeModal()
        })

        const csrftoken = "{{ csrf_token }}"
        const boardBaseUrl = "{% url 'boards:board_detail' board.id %}"
        const endpoints = {
            detail: (cardId) => `${boardBaseUrl}cards/${cardId}/`,
            update: (cardId) => `${boardBaseUrl}cards/${cardId}/update`,
            labelToggle: (cardId) => `${boardBaseUrl}cards/${cardId}/labels/toggle`,
            checklistCreate: (cardId) => `${boardBaseUrl}cards/${cardId}/checklists/create`,
            checklistDelete: (cardId, checklistId) => `${boardBaseUrl}cards/${cardId}/checklists/${checklistId}/delete`,
            subtaskCreate: (cardId) => `${boardBaseUrl}cards/${cardId}/subtasks/create`,
            subtaskToggle: (cardId, subtaskId) => `${boardBaseUrl}cards/${cardId}/subtasks/${subtaskId}/toggle`,
            subtaskDelete: (cardId, subtaskId) => `${boardBaseUrl}cards/${cardId}/subtasks/${subtaskId}/delete`,
            commentCreate: (cardId) => `${boardBaseUrl}cards/${cardId}/comments/create`,
            labelCreate: (cardId) => `${boardBaseUrl}cards/${cardId}/labels/create`,
            labelDelete: (cardId, labelId) => `${boardBaseUrl}cards/${cardId}/labels/${labelId}/delete`,
            cardDelete: (cardId) => `${boardBaseUrl}cards/${cardId}/delete`,
            assign: (cardId) => `${boardBaseUrl}cards/${cardId}/assign`,
        }

        const dom = {
            title: document.getElementById('modal-card-title'),
            mainForm: document.getElementById('card-main-form'),
            dueDate: document.querySelector('#card-main-form input[name="due_date"]'),
            description: document.querySelector('#card-main-form textarea[name="description"]'),
            checklists: document.getElementById('checklists-container'),
            btnAddChecklist: document.getElementById('btn-add-checklist'),
            checklistForm: document.getElementById('checklist-form'),
            checklistTitleInput: document.getElementById('checklist-title-input'),
            checklistCreateConfirm: document.getElementById('checklist-create-confirm'),
            checklistCreateCancel: document.getElementById('checklist-create-cancel'),
            comments: document.getElementById('comments-list'),
            commentForm: document.getElementById('comment-create'),
            labels: document.getElementById('labels-pills'),
            labelForm: document.getElementById('label-create'),
            deleteButton: document.getElementById('card-delete'),
            deleteButtonMobile: document.getElementById('card-delete-mobile'),
            assignedMembers: document.getElementById('modal-assigned-members'),
            membersToggle: document.getElementById('members-list-toggle'),
        }

        const createCardElement = (card) => {
            const article = document.createElement('article')
            article.className = 'group rounded-2xl border border-white/10 bg-slate-950/60 p-4 text-white shadow transition hover:-translate-y-1'
            article.dataset.cardId = card.id
            
            article.innerHTML = `
                <div class="flex items-start justify-between">
                    <h3 class="text-sm font-semibold leading-tight"></h3>
                    <div class="flex items-center gap-2">
                        <div class="flex -space-x-1.5 overflow-hidden" data-card-assignees="${card.id}"></div>
                        <span data-card-due-display="" class="text-xs font-semibold text-emerald-300 hidden"></span>
                        <button type="button" class="tooltip rounded-full p-1 text-slate-500 hover:bg-white/10 hover:text-red-400 transition opacity-0 group-hover:opacity-100 focus:opacity-100" data-tooltip="Archiver" onclick="event.stopPropagation(); window.quickDeleteCard('${card.id}')">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </button>
                    </div>
                </div>
                <div data-card-labels="" class="mt-3 flex flex-wrap gap-2 hidden"></div>
                <p data-card-description="" class="mt-2 text-sm text-slate-300 line-clamp-3 hidden"></p>
                <div class="mt-4 flex items-center justify-between text-xs text-slate-400">
                    <span data-card-stats-subtasks="">‚úÖ 0/0</span>
                    <span data-card-stats-comments="">üí¨ 0</span>
                </div>
            `
            return article
        }

        const renderCard = (card, openModal = false) => {
            // Mise √† jour du modal SEULEMENT si c'est la carte actuellement affich√©e ou si on demande l'ouverture
            const currentModalCardId = dom.mainForm.dataset.cardId
            const isCurrent = currentModalCardId === String(card.id)

            if (isCurrent || openModal) {
                dom.title.textContent = card.title
                dom.mainForm.title.value = card.title
                dom.mainForm.description.value = card.description
                dom.mainForm.due_date.value = card.due_date_local || ''
                dom.mainForm.dataset.cardId = card.id
                dom.commentForm.dataset.cardId = card.id
                dom.labelForm.dataset.cardId = card.id
                dom.deleteButton.dataset.cardId = card.id
                dom.deleteButtonMobile.dataset.cardId = card.id

                dom.assignedMembers.innerHTML = ''
                card.assigned_users.forEach(user => {
                    const avatar = document.createElement('div')
                    avatar.className = 'flex h-8 w-8 items-center justify-center rounded-full bg-emerald-400 text-xs font-bold text-slate-900'
                    avatar.textContent = user.initial
                    avatar.title = user.username
                    dom.assignedMembers.appendChild(avatar)
                })

                dom.membersToggle.innerHTML = ''
                card.members.forEach(member => {
                    const btn = document.createElement('button')
                    btn.type = 'button'
                    btn.className = `flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold transition ${member.is_assigned ? 'bg-emerald-400 text-slate-900' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`
                    btn.innerHTML = `<span class="h-4 w-4 rounded-full bg-white/30 flex items-center justify-center text-[10px]">${member.initial}</span> ${member.username}`
                    btn.onclick = (e) => { e.stopPropagation(); toggleAssignment(card.id, member.id) }
                    dom.membersToggle.appendChild(btn)
                })

                dom.labels.innerHTML = ''
                card.available_labels.forEach(label => {
                    const pill = document.createElement('div')
                    pill.className = 'inline-flex items-center gap-2 rounded-full bg-slate-900/20 px-3 py-1 text-xs font-semibold text-slate-900'
                    const swatch = document.createElement('span')
                    swatch.className = 'inline-block h-3 w-3 rounded-full'
                    swatch.style.backgroundColor = label.color
                    const title = document.createElement('span')
                    title.textContent = label.name
                    const action = document.createElement('button')
                    action.type = 'button'
                    action.textContent = label.assigned ? 'Retirer' : 'Ajouter'
                    action.className = 'text-xs font-semibold text-emerald-600'
                    action.addEventListener('click', (event) => {
                        event.stopPropagation()
                        if (label.assigned) {
                            fetch(endpoints.labelDelete(card.id, label.id), { method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
                                .then(res => res.json()).then(c => renderCard(c))
                        } else {
                            toggleLabel(card.id, label.id)
                        }
                    })
                    pill.appendChild(swatch)
                    pill.appendChild(title)
                    pill.appendChild(action)
                    dom.labels.appendChild(pill)
                })

                // Checklists rendering
                dom.checklists.innerHTML = ''
                
                // Group standalone subtasks into a virtual "Checklist" if any exist
                if (card.subtasks && card.subtasks.length > 0) {
                    renderChecklistSection({
                        id: null,
                        title: '√âl√©ments',
                        items: card.subtasks,
                        percent: intPercent(card.subtasks),
                        is_standalone: true
                    }, card.id)
                }

                card.checklists.forEach(cl => {
                    renderChecklistSection(cl, card.id)
                })

                function intPercent(items) {
                    const total = items.length
                    if (total === 0) return 0
                    const completed = items.filter(i => i.is_completed).length
                    return Math.round((completed / total) * 100)
                }

                function renderChecklistSection(cl, cardId) {
                    const section = document.createElement('section')
                    section.className = 'space-y-3'
                    section.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">‚òë</span>
                                <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-700">${cl.title}</h3>
                            </div>
                            ${!cl.is_standalone ? `<button class="text-[10px] font-bold uppercase text-red-400 hover:text-red-600" onclick="deleteChecklist(${cardId}, ${cl.id})">Supprimer</button>` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-slate-400">${cl.percent}%</span>
                            <div class="h-2 flex-1 rounded-full bg-slate-100 overflow-hidden">
                                <div class="h-full bg-emerald-500 transition-all duration-500" style="width: ${cl.percent}%"></div>
                            </div>
                        </div>
                        <ul class="space-y-1">
                            ${cl.items.map(item => `
                                <li class="group flex items-center justify-between rounded-lg border border-transparent px-2 py-1 hover:border-slate-100 hover:bg-slate-50">
                                    <label class="flex flex-1 items-center gap-3 text-sm cursor-pointer">
                                        <input type="checkbox" class="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" ${item.is_completed ? 'checked' : ''} onchange="toggleSubtask(${cardId}, ${item.id})">
                                        <span class="${item.is_completed ? 'line-through text-slate-400' : 'text-slate-700'}">${item.title}</span>
                                    </label>
                                    <button class="opacity-0 group-hover:opacity-100 text-xs text-slate-400 hover:text-red-500 transition" onclick="deleteSubtask(${cardId}, ${item.id})">‚úï</button>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="mt-2 pl-8">
                            ${!cl.is_standalone ? `
                            <button class="text-xs font-semibold text-slate-500 hover:text-slate-800" onclick="showItemForm(${cl.id})">+ Ajouter un √©l√©ment</button>
                            <div id="item-form-${cl.id}" class="hidden mt-2 space-y-2">
                                <input type="text" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-emerald-400 focus:outline-none" placeholder="Nom de l'√©l√©ment">
                                <div class="flex gap-2">
                                    <button onclick="addChecklistItem(${cardId}, ${cl.id})" class="rounded-md bg-emerald-600 px-3 py-1 text-xs font-semibold text-white">Ajouter</button>
                                    <button onclick="hideItemForm(${cl.id})" class="text-xs text-slate-500">Annuler</button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `
                    dom.checklists.appendChild(section)
                }

                dom.comments.innerHTML = ''
                card.comments.forEach(comment => {
                    const li = document.createElement('li')
                    li.className = 'rounded-lg border border-slate-200 px-3 py-2'
                    li.innerHTML = `
                        <p class="text-xs font-semibold text-slate-500">${comment.author} ‚Äî ${comment.created_at}</p>
                        <p class="text-sm text-slate-800">${comment.content}</p>
                    `
                    dom.comments.appendChild(li)
                })
                
                if (openModal) modal.classList.remove('hidden')
            }

            // Mise √† jour ou cr√©ation de la preview dans la liste
            let preview = document.querySelector(`[data-card-id="${card.id}"]`)
            if (!preview) {
                const container = document.querySelector(`.card-container[data-list-id="${card.list_id}"]`)
                if (container) {
                    preview = createCardElement(card)
                    container.appendChild(preview)
                    // Sortable sur le container g√®re normalement les nouveaux √©l√©ments automatiquement
                }
            }

            if (preview) {
                // Mise √† jour des donn√©es pour le filtrage
                preview.dataset.cardLabels = card.labels.map(l => l.id).join(',') + ','
                preview.dataset.cardDue = card.due_date ? card.due_date.split('T')[0] : ''
                const now = new Date()
                const dueDate = card.due_date ? new Date(card.due_date) : null
                preview.dataset.cardOverdue = (dueDate && dueDate < now) ? '1' : '0'

                // Mise √† jour visuelle
                const titleEl = preview.querySelector('h3')
                if (titleEl) titleEl.textContent = card.title

                const descEl = preview.querySelector('[data-card-description]')
                if (descEl) {
                    descEl.textContent = card.description
                    descEl.classList.toggle('hidden', !card.description)
                }

                const dueEl = preview.querySelector('[data-card-due-display]')
                if (dueEl) {
                    if (card.due_date_display) {
                        dueEl.textContent = `üìÖ ${card.due_date_display.split(' ')[0]}`
                        dueEl.classList.remove('hidden')
                        if (preview.dataset.cardOverdue === '1') {
                            dueEl.classList.add('text-red-400')
                            dueEl.classList.remove('text-emerald-300')
                        } else {
                            dueEl.classList.remove('text-red-400')
                            dueEl.classList.add('text-emerald-300')
                        }
                    } else {
                        dueEl.classList.add('hidden')
                    }
                }

                const labelsWrapper = preview.querySelector('[data-card-labels]')
                if (labelsWrapper) {
                    labelsWrapper.innerHTML = ''
                    if (card.labels.length > 0) {
                        labelsWrapper.classList.remove('hidden')
                        card.labels.forEach(label => {
                            const span = document.createElement('span')
                            span.className = 'inline-flex items-center rounded-full px-2 py-1 text-[10px] font-semibold text-white'
                            span.style.backgroundColor = label.color
                            span.textContent = label.name
                            labelsWrapper.appendChild(span)
                        })
                    } else {
                        labelsWrapper.classList.add('hidden')
                    }
                }

                const assigneesWrapper = preview.querySelector('[data-card-assignees]')
                if (assigneesWrapper) {
                    assigneesWrapper.innerHTML = ''
                    card.assigned_users.forEach(u => {
                        const div = document.createElement('div')
                        div.className = 'inline-block h-5 w-5 rounded-full border border-slate-900 bg-emerald-400 text-[9px] font-bold text-slate-900 flex items-center justify-center'
                        div.title = u.username
                        div.textContent = u.initial
                        assigneesWrapper.appendChild(div)
                    })
                }

                const subtasksStats = preview.querySelector('[data-card-stats-subtasks]')
                if (subtasksStats) {
                    subtasksStats.textContent = `‚úÖ ${card.completed_subtasks}/${card.total_subtasks}`
                }

                const commentsStats = preview.querySelector('[data-card-stats-comments]')
                if (commentsStats) {
                    commentsStats.textContent = `üí¨ ${card.comment_count}`
                }

                refreshEmptyState(preview)
            }
        }

        const fetchCard = (cardId) => {
            showLoader()
            fetch(endpoints.detail(cardId))
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Le serveur a retourn√© une erreur.`);
                    }
                    return res.json();
                })
                .then(card => {
                    renderCard(card, true);
                })
                .catch(error => {
                    console.error('Impossible de charger les d√©tails de la carte:', error);
                    pushToast('Une erreur est survenue lors du chargement de la carte.', 'error');
                })
                .finally(hideLoader);
        }

        const jsonFetch = (url, payload) => {
            showLoader()
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(payload)
            }).then(res => {
                if (!res.ok) throw res
                return res.json()
            }).then(card => renderCard(card))
            .finally(hideLoader)
        }

        const toggleLabel = (cardId, labelId) => jsonFetch(endpoints.labelToggle(cardId), { label_id: labelId })
        const toggleAssignment = (cardId, userId) => jsonFetch(endpoints.assign(cardId), { user_id: userId })
        window.toggleSubtask = (cardId, subtaskId) => jsonFetch(endpoints.subtaskToggle(cardId, subtaskId), {})
        window.deleteSubtask = (cardId, subtaskId) => jsonFetch(endpoints.subtaskDelete(cardId, subtaskId), {})

        window.toggleChecklistForm = () => {
            dom.checklistForm.classList.toggle('hidden')
            if (!dom.checklistForm.classList.contains('hidden')) {
                dom.checklistTitleInput.focus()
            }
        }

        window.showItemForm = (checklistId) => {
            const form = document.getElementById(`item-form-${checklistId}`)
            if (form) {
                form.classList.remove('hidden')
                form.querySelector('input').focus()
            }
        }

        window.hideItemForm = (checklistId) => {
            const form = document.getElementById(`item-form-${checklistId}`)
            if (form) form.classList.add('hidden')
        }

        window.addChecklist = () => {
            const title = dom.checklistTitleInput.value.trim()
            if (!title) return
            const cardId = dom.mainForm.dataset.cardId
            jsonFetch(endpoints.checklistCreate(cardId), { title }).then(() => {
                dom.checklistTitleInput.value = ''
                dom.checklistForm.classList.add('hidden')
            })
        }

        window.deleteChecklist = async (cardId, checklistId) => {
            if (await window.confirmAction('Supprimer cette checklist ?')) {
                jsonFetch(endpoints.checklistDelete(cardId, checklistId), {})
            }
        }

        window.addChecklistItem = (cardId, checklistId) => {
            const form = document.getElementById(`item-form-${checklistId}`)
            const input = form.querySelector('input')
            const title = input.value.trim()
            if (!title) return
            jsonFetch(endpoints.subtaskCreate(cardId), { title, checklist_id: checklistId }).then(() => {
                input.value = ''
                form.classList.add('hidden')
            })
        }

        dom.btnAddChecklist.addEventListener('click', toggleChecklistForm)
        dom.checklistCreateCancel.addEventListener('click', toggleChecklistForm)
        dom.checklistCreateConfirm.addEventListener('click', addChecklist)
        dom.checklistTitleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addChecklist()
        })

        dom.mainForm.addEventListener('submit', (event) => {
            event.preventDefault()
            const cardId = dom.mainForm.dataset.cardId
            jsonFetch(endpoints.update(cardId), {
                title: dom.mainForm.title.value,
                description: dom.mainForm.description.value,
                due_date: dom.mainForm.due_date.value,
            })
        })


        dom.commentForm.addEventListener('submit', (event) => {
            event.preventDefault()
            const content = dom.commentForm.content.value.trim()
            if (!content) return
            const cardId = dom.commentForm.dataset.cardId
            jsonFetch(endpoints.commentCreate(cardId), { content }).then(() => {
                dom.commentForm.reset()
            }).catch(res => {
                if (res.status === 403) {
                    alert('Connexion requise pour commenter.')
                }
            })
        })

        dom.labelForm.addEventListener('submit', (event) => {
            event.preventDefault()
            const cardId = dom.labelForm.dataset.cardId
            const name = dom.labelForm.name.value.trim()
            const color = dom.labelForm.color.value
            if (!name) return
            jsonFetch(endpoints.labelCreate(cardId), { name, color }).then(() => {
                dom.labelForm.reset()
                dom.labelForm.color.value = '#3b82f6'
            })
        })

        window.quickDeleteCard = async (cardId) => {
            const ok = await window.confirmAction('Archiver cette carte ?')
            if (!ok) return
            showLoader()
            fetch(endpoints.cardDelete(cardId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
            }).then(res => {
                if (!res.ok) throw new Error('Erreur lors de la suppression')
                return res.json()
            }).then(data => {
                const preview = document.querySelector(`[data-card-id="${data.card_id}"]`)
                if (preview) {
                    const container = preview.closest('.card-container')
                    preview.remove()
                    if (container) refreshEmptyState(container)
                }
                pushToast('La carte a √©t√© archiv√©e avec succ√®s.')
            }).catch(err => {
                pushToast(err.message, 'error')
            }).finally(hideLoader)
        }

        const deleteCard = async () => {
            const cardId = dom.deleteButton.dataset.cardId
            if (!cardId) return
            const ok = await window.confirmAction('Archiver cette carte ?')
            if (!ok) return
            showLoader()
            fetch(endpoints.cardDelete(cardId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
            }).then(res => {
                if (!res.ok) throw new Error('Erreur lors de la suppression')
                return res.json()
            }).then(data => {
                const preview = document.querySelector(`[data-card-id="${data.card_id}"]`)
                if (preview) {
                    const container = preview.closest('.card-container')
                    preview.remove()
                    if (container) refreshEmptyState(container)
                }
                pushToast('La carte a √©t√© archiv√©e avec succ√®s.')
                closeModal()
            }).catch(err => {
                pushToast(err.message, 'error')
            }).finally(hideLoader)
        }

        dom.deleteButton.addEventListener('click', deleteCard)
        dom.deleteButtonMobile.addEventListener('click', deleteCard)

        const currentSort = "{{ current_sort|default:'position' }}"
        const initDragAndDrop = () => {
            const boardCanvas = document.getElementById('board-canvas')
            if (!boardCanvas) return
            const reorderCardsUrl = "{% url 'boards:reorder_cards' board.id %}";
            const reorderListsUrl = "{% url 'boards:reorder_lists' board.id %}";
            
            // Toujours permettre de r√©ordonner les listes
            new Sortable(boardCanvas, {
                animation: 200,
                handle: 'h2',
                draggable: '[data-list-id]',
                filter: '.ignore-drag', // Ignore elements with this class
                onEnd: () => {
                    const order = Array.from(boardCanvas.querySelectorAll('[data-list-id]')).map(list => list.dataset.listId)
                    fetch(reorderListsUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ order }),
                    }).catch(() => pushToast('Le changement d\'ordre des listes a √©chou√©. Veuillez r√©essayer.', 'error'))
                },
            })

            const debounce = (fn, delay = 400) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn.apply(null, args), delay);
                };
            };

            const sendOrder = debounce(() => {
                const listsPayload = [];
                document.querySelectorAll('.card-container').forEach(container => {
                    const listId = container.dataset.listId;
                    const cardIds = Array.from(container.querySelectorAll('[data-card-id]')).map(card => card.dataset.cardId);
                    listsPayload.push({ id: listId, card_ids: cardIds });
                });

                fetch(reorderCardsUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ lists: listsPayload })
                }).catch(() => {
                    pushToast('L\'ordre des cartes n\'a pas pu √™tre sauvegard√©. Veuillez r√©essayer.', 'error');
                });
            }, 300);

            document.querySelectorAll('.card-container').forEach(container => {
                new Sortable(container, {
                    group: 'cards',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    disabled: currentSort !== 'position', // D√©sactiv√© si tri automatique actif
                    // Always allow opening card details on tap
                    onEnd: (event) => {
                        sendOrder()
                        refreshEmptyState(event.from)
                        refreshEmptyState(event.to)
                    },
                });
            });

            // Add click listeners to cards AFTER Sortable has been initialized
            document.querySelectorAll('article[data-card-id]').forEach(cardElement => {
                cardElement.addEventListener('click', (event) => {
                    // Emp√™che la propagation de l'√©v√©nement pour √©viter les conflits avec Sortable.js
                    event.stopPropagation();
                    const cardId = cardElement.dataset.cardId;
                    if (cardId) {
                        fetchCard(cardId);
                    }
                });
            });

            document.querySelectorAll('.card-container').forEach(refreshEmptyState)
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDragAndDrop)
        } else {
            initDragAndDrop()
        }

        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            const exportDropdown = document.getElementById('export-dropdown');
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (exportDropdown && !exportDropdown.contains(e.target) && e.target !== exportBtn) {
                    exportDropdown.classList.add('hidden');
                }
            });
        }
        // --- WebSocket temps r√©el ---
        (function() {
            const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws'
            const wsUrl = `${scheme}://${window.location.host}/ws/boards/{{ board.id }}/`
            let socket = null
            let reconnectDelay = 2000

            function connect() {
                console.info('Tentative de connexion WebSocket...', wsUrl)
                try {
                    socket = new WebSocket(wsUrl)
                } catch (e) {
                    console.error('Erreur lors de la cr√©ation du WebSocket:', e)
                    return
                }

                socket.onopen = () => {
                    console.info('WebSocket connect√© !')
                    window.pushToast('Vous √™tes maintenant connect√© en temps r√©el.', 'info')
                    reconnectDelay = 2000 // Reset delay on success
                }

                socket.onmessage = (event) => {
                    console.debug('WebSocket message re√ßu:', event.data)
                    try {
                        const payload = JSON.parse(event.data)
                        const action = payload.action || 'update'
                        
                        if (action === 'card.updated' && payload.card) {
                            renderCard(payload.card)
                            window.pushToast('La carte a √©t√© mise √† jour par un autre utilisateur.', 'info')
                        } else if (action === 'card.deleted' && payload.card_id) {
                            const preview = document.querySelector(`[data-card-id="${payload.card_id}"]`)
                            if (preview) {
                                const container = preview.closest('.card-container')
                                preview.remove()
                                if (container) refreshEmptyState(container)
                            }
                            window.pushToast('Une carte a √©t√© archiv√©e par un autre utilisateur.', 'info')
                        } else if (action === 'card.created' && payload.card) {
                            renderCard(payload.card)
                            window.pushToast('Une nouvelle carte a √©t√© ajout√©e.', 'info')
                        } else if (action === 'list.deleted' && payload.list_id) {
                            const listEl = document.querySelector(`[data-list-id="${payload.list_id}"]`)
                            if (listEl) listEl.remove()
                            window.pushToast('Une liste a √©t√© supprim√©e par un autre utilisateur.', 'info')
                        } else if (action === 'cards.reordered' && payload.lists) {
                            payload.lists.forEach(listData => {
                                const container = document.querySelector(`.card-container[data-list-id="${listData.id}"]`)
                                if (container) {
                                    listData.card_ids.forEach(cardId => {
                                        const card = document.querySelector(`[data-card-id="${cardId}"]`)
                                        if (card) container.appendChild(card)
                                    })
                                    refreshEmptyState(container)
                                }
                            })
                            window.pushToast('L\'ordre des cartes a √©t√© modifi√©.', 'info')
                        } else if (action === 'lists.reordered' && payload.order) {
                            const canvas = document.getElementById('board-canvas')
                            if (canvas) {
                                payload.order.forEach(listId => {
                                    const list = canvas.querySelector(`[data-list-id="${listId}"]`)
                                    if (list) canvas.insertBefore(list, canvas.lastElementChild)
                                })
                            }
                            window.pushToast('L\'ordre des listes a √©t√© modifi√©.', 'info')
                        }
                    } catch (e) {
                        console.error('Erreur lors du traitement du message WebSocket:', e)
                    }
                }

                socket.onclose = (e) => {
                    console.warn(`WebSocket d√©connect√© (code=${e.code}). Reconnexion dans ${reconnectDelay}ms...`)
                    if (e.code === 4401 || e.code === 4403) {
                        console.error('Acc√®s WebSocket refus√©. Pas de reconnexion.')
                        return
                    }
                    setTimeout(connect, reconnectDelay)
                    reconnectDelay = Math.min(reconnectDelay * 2, 30000) // Exponential backoff
                }

                socket.onerror = (err) => {
                    console.error('Erreur WebSocket:', err)
                    if (socket) {
                        try { socket.close() } catch(_) {}
                    }
                }
            }
            
            // On attend un peu que tout soit pr√™t avant de lancer le WS
            if (document.readyState === 'complete') connect()
            else window.addEventListener('load', connect)
        })()
    </script>
 </body>
 </html>
