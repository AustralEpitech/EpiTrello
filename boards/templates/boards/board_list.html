{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>EpiTrello · Tableaux</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'boards/theme.css' %}">
    <script src="{% static 'boards/app.js' %}" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-930 to-slate-900 text-white">
    <div class="relative isolate">
        <div class="absolute inset-x-0 -top-24 -z-10 h-72 bg-emerald-500/30 blur-3xl"></div>
        <header class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-6 px-6 py-10">
            <div class="flex items-center gap-6">
                <a href="{% url 'home' %}" class="group">
                    <div class="rounded-lg bg-emerald-400/20 p-2 group-hover:bg-emerald-400/30 transition-colors">
                        <span class="text-xl font-black text-emerald-300">ET</span>
                    </div>
                </a>
                <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-emerald-300">EpiTrello</p>
                    <h1 class="text-4xl font-black leading-tight">Organise tes tableaux</h1>
                    <p class="text-sm text-slate-300">Tous tes espaces de travail, filtres et actions en un coup d’œil.</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                {% if user.is_authenticated %}
                <a href="{% url 'boards:global_search' %}" class="rounded-full bg-white/10 p-2 text-white hover:bg-white/20 btn-focus-visible" data-tooltip="Recherche globale">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </a>
                <a href="{% url 'boards:notifications_list' %}" class="relative rounded-full bg-white/10 p-2 text-white hover:bg-white/20 btn-focus-visible" data-tooltip="Mes notifications">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    {% if unread_notifications_count > 0 %}
                        <span class="absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-emerald-500 text-[10px] font-bold text-slate-900">{{ unread_notifications_count }}</span>
                    {% endif %}
                </a>
                {% endif %}
                <button type="button" onclick="openBoardModal()" class="inline-flex items-center gap-2 rounded-full bg-emerald-400 px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/40 hover:bg-emerald-300" data-tooltip="Créer un nouvel espace">
                    <span class="text-lg">＋</span> Nouveau tableau
                </button>
                {% if user.is_authenticated %}
                <a href="{% url 'boards:profile' %}" class="flex h-11 w-11 items-center justify-center rounded-full bg-white/10 font-bold text-white hover:bg-white/20 btn-focus-visible shadow-lg" data-tooltip="Mon Profil">
                    {{ user.username|slice:":1"|upper }}
                </a>
                {% endif %}
            </div>
        </header>

        <section class="mx-auto max-w-6xl space-y-6 px-6">
            <form id="boards-filter" class="flex flex-wrap gap-4 rounded-3xl border border-white/10 bg-white/5 p-5 text-sm text-white" method="get">
                <label class="flex flex-1 items-center gap-2 rounded-2xl border border-white/5 bg-white/5 px-3 py-2">
                    <svg class="h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input name="q" value="{{ query }}" placeholder="Rechercher un tableau" class="w-full bg-transparent text-white placeholder-slate-500 focus:outline-none" autocomplete="off">
                </label>
                <select name="sort" class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-white focus:border-emerald-400 focus:outline-none">
                    <option class="text-slate-900" value="recent" {% if sort == 'recent' %}selected{% endif %}>Plus récents</option>
                    <option class="text-slate-900" value="alphabetic" {% if sort == 'alphabetic' %}selected{% endif %}>A → Z</option>
                    <option class="text-slate-900" value="activity" {% if sort == 'activity' %}selected{% endif %}>Activité</option>
                </select>
                <select name="owner" class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-white focus:border-emerald-400 focus:outline-none">
                    <option class="text-slate-900" value="all" {% if owner_filter == 'all' %}selected{% endif %}>Tous les propriétaires</option>
                    <option class="text-slate-900" value="me" {% if owner_filter == 'me' %}selected{% endif %}>Mes tableaux</option>
                </select>
            </form>

            {% include "boards/partials/board_grid.html" %}
        </section>
    </div>

    <div id="board-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 px-4 py-10">
        <div class="w-full max-w-md rounded-3xl border border-white/10 bg-white/10 p-6 text-white backdrop-blur">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Créer</p>
                    <h2 class="text-2xl font-semibold">Nouveau tableau</h2>
                </div>
                <button type="button" onclick="closeBoardModal()" class="rounded-full border border-white/10 px-3 py-1 text-sm font-semibold hover:bg-white/10">✕</button>
            </div>
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'boards:create_board' %}" class="mt-6 space-y-4">
                    {% csrf_token %}
                    <div>
                        <label class="text-sm font-semibold text-slate-200">Titre</label>
                        <input name="title" maxlength="100" class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-white focus:border-emerald-400 focus:outline-none" placeholder="Roadmap Q1" required>
                    </div>
                    <button type="submit" class="w-full rounded-2xl bg-emerald-400 px-4 py-2 text-sm font-semibold text-slate-900 shadow hover:bg-emerald-300">Créer</button>
                </form>
            {% else %}
                <p class="mt-6 text-sm text-slate-300">Connecte-toi pour créer des tableaux.</p>
                <a href="{% url 'account_login' %}" class="mt-3 inline-flex w-full justify-center rounded-2xl border border-white/10 px-4 py-2 text-sm font-semibold text-white hover:bg-white/10">Aller à la connexion</a>
            {% endif %}
        </div>
    </div>

    <div id="rename-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 px-4 py-10">
        <div class="w-full max-w-md rounded-3xl border border-white/10 bg-white/10 p-6 text-white backdrop-blur">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold">Renommer</h2>
                <button type="button" onclick="closeRename()" class="rounded-full border border-white/10 px-3 py-1 text-sm font-semibold hover:bg-white/10">✕</button>
            </div>
            <form id="rename-form" method="post" class="mt-6 space-y-4">
                {% csrf_token %}
                <label class="text-sm font-semibold text-slate-200">Nouveau nom</label>
                <input name="title" class="w-full rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-white focus:border-emerald-400 focus:outline-none" required>
                <button type="submit" class="w-full rounded-2xl bg-emerald-400 px-4 py-2 text-sm font-semibold text-slate-900">Renommer</button>
            </form>
        </div>
    </div>

    <div id="toast-stack" class="fixed inset-x-0 top-6 z-50 mx-auto flex max-w-md flex-col gap-3 px-4"></div>

    <div id="global-loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/20 backdrop-blur-[1px] opacity-0 invisible">
        <div class="flex flex-col items-center gap-3">
            <div class="spinner"></div>
            <p class="text-xs font-bold uppercase tracking-[0.2em] text-emerald-400">Recherche...</p>
        </div>
    </div>

    <script>
        const boardModal = document.getElementById('board-modal')
        const renameModal = document.getElementById('rename-modal')
        const renameForm = document.getElementById('rename-form')
        const toastStack = document.getElementById('toast-stack')
        const loader = document.getElementById('global-loader')
        const showLoader = () => { loader.classList.remove('opacity-0', 'invisible'); loader.classList.add('opacity-100', 'visible') }
        const hideLoader = () => { loader.classList.add('opacity-0', 'invisible'); loader.classList.remove('opacity-100', 'visible') }

        function navigateBoard(url) {
            window.location.href = url
        }

        function openBoardModal() {
            boardModal.classList.remove('hidden')
            boardModal.classList.add('flex')
        }
        function closeBoardModal() {
            boardModal.classList.add('hidden')
            boardModal.classList.remove('flex')
        }
        boardModal?.addEventListener('click', (e) => { if (e.target === boardModal) closeBoardModal() })

        function openRename(id, title) {
            renameForm.action = `{% url 'boards:rename_board' 0 %}`.replace('/0/', `/${id}/`)
            renameForm.title.value = title
            renameModal.classList.remove('hidden')
            renameModal.classList.add('flex')
        }
        function closeRename() {
            renameModal.classList.add('hidden')
            renameModal.classList.remove('flex')
        }
        renameModal?.addEventListener('click', (e) => { if (e.target === renameModal) closeRename() })

        document.addEventListener('DOMContentLoaded', () => {
            {% if messages %}
                {% for message in messages %}
                    window.pushToast("{{ message|escapejs }}", "{{ message.tags }}")
                {% endfor %}
            {% endif %}
        });

        const filterForm = document.getElementById('boards-filter')
        if (filterForm) {
            const debounce = (fn, delay = 300) => {
                let timeout
                return (...args) => {
                    clearTimeout(timeout)
                    timeout = setTimeout(() => fn.apply(null, args), delay)
                }
            }
            const fetchBoards = () => {
                showLoader()
                const params = new URLSearchParams(new FormData(filterForm))
                fetch(`${window.location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser()
                        const doc = parser.parseFromString(html, 'text/html')
                        const grid = doc.querySelector('[data-board-grid]')
                        const target = document.querySelector('[data-board-grid]')
                        if (grid && target) {
                            target.innerHTML = grid.innerHTML
                        } else {
                            window.location.search = params.toString()
                        }
                    })
                    .finally(hideLoader)
            }
            filterForm.querySelectorAll('input[name="q"], select').forEach(input => {
                input.addEventListener(input.tagName === 'SELECT' ? 'change' : 'input', debounce(fetchBoards))
            })
        }
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('new') === '1' || window.location.hash === '#new') {
                openBoardModal();
            }
        });
    </script>
</body>
</html>
